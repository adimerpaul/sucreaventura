import{v as _,x as R,j as O,ad as j,a4 as g,o as u,a as l,w as m,e as V,b as n,ap as p,t as h,f as y,a0 as f,c as $,a3 as k,a5 as b,a6 as M,a7 as S,Q as C,aw as q,aq as T,ar as B,Z as D,h as H}from"./index-Brl0qRmY.js";import{Q as w,a as N}from"./QTh-DdKZsJa7.js";import{Q as F}from"./QMarkupTable-Bpuv7Aop.js";import{Q as P}from"./QSpace-2C5WFtnj.js";import{Q as U}from"./QForm-B0VfA2qh.js";import{C as A}from"./ClosePopup-B20x9lrE.js";import{h as v}from"./moment-C5S46NFB.js";import{_ as x}from"./_plugin-vue_export-helper-DlAUqK2U.js";const z=["top","middle","bottom"],Q=_({name:"QBadge",props:{color:String,textColor:String,floating:Boolean,transparent:Boolean,multiLine:Boolean,outline:Boolean,rounded:Boolean,label:[Number,String],align:{type:String,validator:s=>z.includes(s)}},setup(s,{slots:e}){const r=R(()=>s.align!==void 0?{verticalAlign:s.align}:null),a=R(()=>{const t=s.outline===!0&&s.color||s.textColor;return`q-badge flex inline items-center no-wrap q-badge--${s.multiLine===!0?"multi":"single"}-line`+(s.outline===!0?" q-badge--outline":s.color!==void 0?` bg-${s.color}`:"")+(t!==void 0?` text-${t}`:"")+(s.floating===!0?" q-badge--floating":"")+(s.rounded===!0?" q-badge--rounded":"")+(s.transparent===!0?" q-badge--transparent":"")});return()=>O("div",{class:a.value,style:r.value,role:"status","aria-label":s.label},j(e.default,s.label!==void 0?[s.label]:[]))}}),E={name:"FormularioReservas",props:{agencia:{type:String,required:!1},color:{type:String,required:!1}},data(){return{fecha:v().format("YYYY-MM-DD"),salas:[],horarios:[],seleccionadas:{},totalMinutos:0,dialogoReservar:!1,nombre:"",personas:1,adelanto:0,observacion:"",loading:!1,directo:!1}},computed:{fechaText(){const s=["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"],e=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];return`${s[v(this.fecha).day()]} ${v(this.fecha).date()} de ${e[v(this.fecha).month()]} de ${v(this.fecha).year()}`},tiempoSeleccionado(){const s=Math.floor(this.totalMinutos/60),e=this.totalMinutos%60;return`${String(s).padStart(2,"0")}:${String(e).padStart(2,"0")}`},montoTotal(){return this.totalMinutos/30*5*(this.personas||1)},horaMinima(){return Object.keys(this.seleccionadas).length===0?"-":Object.values(this.seleccionadas).map(e=>v(e,"H:mm")).sort((e,r)=>e.diff(r))[0].format("H:mm")},horaMaxima(){if(Object.keys(this.seleccionadas).length===0)return"-";const s=Object.values(this.seleccionadas).map(r=>v(r,"H:mm")).sort((r,a)=>r.diff(a));return s[s.length-1].add(30,"minutes").format("H:mm")}},methods:{esPrimeraCeldaReserva(s,e){const r=`${s}-${e}`,a=`${s-1}-${e}`;return this.$store.reservas[r]?!this.$store.reservas[a]||this.$store.reservas[a].nombre!==this.$store.reservas[r].nombre:!1},getRowspan(s,e){const r=`${s}-${e}`;if(!this.$store.reservas[r])return 1;let a=1;for(;this.$store.reservas[`${s+a}-${e}`]&&this.$store.reservas[`${s+a}-${e}`].nombre===this.$store.reservas[r].nombre;)a++;return a},getReservas(s,e){this.loading=!0,this.$store.reservas={},this.$axios.get("/reservas",{params:{fecha:s,agencia:e}}).then(r=>{this.$store.reservas=r.data}).catch(()=>{this.$alert.error("Error al obtener reservas")}).finally(()=>{this.loading=!1})},limpiar(){this.seleccionadas={},this.totalMinutos=0,this.nombre="",this.personas=1,this.adelanto=0,this.observacion=""},clickReserva(){if(this.totalMinutos===0){this.$alert.error("Por favor selecciona al menos 30 minutos.");return}this.dialogoReservar=!0,this.nombre="",this.personas=2,this.adelanto=0,this.observacion="",this.directo=!1},shouldShowCell(s,e){const r=`${s}-${e}`,a=`${s-1}-${e}`;return this.$store.reservas[r]?!(s>0&&this.$store.reservas[a]&&this.$store.reservas[a].nombre===this.$store.reservas[r].nombre):!0},toggleSeleccion(s,e,r){const a=`${s}-${e}`;if(!this.$store.reservas[a]){if(Object.keys(this.seleccionadas).length===0){this.seleccionadas[a]=r,this.calcularTotalMinutos();return}if(Object.keys(this.seleccionadas).length>0){const t=new Set(Object.keys(this.seleccionadas).map(o=>o.split("-")[1]));if(t.size>0&&!t.has(String(e))){this.$alert.error("Debes seleccionar en la misma sala.");return}const i=Object.keys(this.seleccionadas).map(o=>parseInt(o.split("-")[0])).sort((o,c)=>o-c);if(i.length>0){const o=i[i.length-1];if(s!==o+1){this.$alert.error("Debes seleccionar horarios consecutivos.");return}}}this.seleccionadas[a]?delete this.seleccionadas[a]:this.seleccionadas[a]=r,this.calcularTotalMinutos()}},calcularTotalMinutos(){this.totalMinutos=Object.keys(this.seleccionadas).length*30},confirmarReserva(){Object.keys(this.seleccionadas).forEach(a=>{this.$store.reservas[a]={nombre:this.nombre,personas:this.personas,color:"yellow"}});const e=Object.keys(this.seleccionadas)[0].split("-")[1],r=this.salas[e]?.sala||"Desconocida";this.loading=!0,this.$axios.post("/reservas",{nombre:this.nombre,numero_personas:this.personas,observaciones:this.observacion,json:JSON.stringify(this.seleccionadas),sala:r,total:this.montoTotal,adelanto:this.adelanto,tiempo:this.tiempoSeleccionado,horario:`${this.horaMinima} - ${this.horaMaxima}`,fecha:this.fecha,directo:this.directo,agencia:this.agencia}).then(()=>{this.$alert.success("Reserva confirmada","Reserva"),this.limpiar(),this.getReservas(this.fecha,this.agencia),this.dialogoReservar=!1,this.$socket.emit(`reservas-${this.agencia}`)}).catch(a=>{this.$alert.error(a.response.data.message,"Error al confirmar reserva")}).finally(()=>{this.loading=!1})}},mounted(){console.log("agencia "+this.agencia),console.log("color "+this.color);let s=15;for(let r=0;r<s;r++)this.salas.push({sala:"Sala "+(r+1)});for(let r=8;r<23;r++){let a=`${r}:00`,t=`${r}:30`;this.horarios.push({hora:`${a}-${t}`}),a=`${r}:30`,t=`${r+1}:00`,this.horarios.push({hora:`${a}-${t}`})}this.calcularTotalMinutos(),this.getReservas(this.fecha,this.agencia);let e=this;this.$store.socketReservas||(this.$store.socketReservas={}),this.$store.socketReservas[this.agencia]||(this.$socket.on(`reservas-${this.agencia}`,()=>{e.getReservas(this.fecha,this.agencia)}),this.$store.socketReservas[this.agencia]=!0)}},L={class:"row"},J={class:"col-6 col-md-2"},K={class:"col-6 col-md-2 text-center flex flex-center"},Y={class:"text-bold text-red"},Z={class:"col-6 col-md-2 flex flex-center"},G={class:"col-6 col-md-2"},W={class:"col-6 col-md-2 text-right"},X={class:"scroll-body"},I=["onClick"],ee={key:0},se={key:0},te={class:"text-subtitle2 text-bold"},oe={class:"text-red"},re={class:"text-bold q-mt-md text-blue bg-grey-3"},ae={class:"text-bold"},le={class:"text-red text-bold"};function ie(s,e,r,a,t,i){return u(),g(b,null,[l(C,{flat:"",bordered:""},{default:m(()=>[l(V,{class:"q-pa-xs"},{default:m(()=>[n("div",L,[n("div",J,[l(p,{modelValue:t.fecha,"onUpdate:modelValue":[e[0]||(e[0]=o=>t.fecha=o),e[1]||(e[1]=o=>i.getReservas(t.fecha,r.agencia))],type:"date",label:"Fecha",dense:"",outlined:""},null,8,["modelValue"])]),n("div",K,[n("div",Y,h(i.fechaText),1)]),n("div",Z,[l(y,{color:"green",label:"Reservar",onClick:i.clickReserva,"no-caps":"",icon:"save",size:"11px",loading:t.loading},null,8,["onClick","loading"])]),n("div",G,[l(Q,{color:"indigo",class:"q-pa-sm"},{default:m(()=>[f(" Tiempo Seleccionado: "+h(i.tiempoSeleccionado),1)]),_:1})]),n("div",W,[Object.keys(t.seleccionadas).length>0?(u(),$(y,{key:0,color:"red",label:"Limpiar",onClick:i.limpiar,"no-caps":"",icon:"clear",size:"11px"},null,8,["onClick"])):k("",!0)]),e[12]||(e[12]=n("div",{class:"col-6 col-md-2 text-right"},null,-1))]),l(F,{"wrap-cells":"",dense:"",bordered:"",flat:"",separator:"cell",class:"tabla-reservas"},{default:m(()=>[n("thead",null,[n("tr",null,[l(w,{class:"bg-grey text-white sticky-hora"},{default:m(()=>e[13]||(e[13]=[f("Hora")])),_:1}),(u(!0),g(b,null,M(t.salas,o=>(u(),$(w,{class:S(`bg-${r.color} text-white`),key:o.sala},{default:m(()=>[f(h(o.sala),1)]),_:2},1032,["class"]))),128))])]),n("tbody",X,[(u(!0),g(b,null,M(t.horarios,(o,c)=>(u(),g("tr",{key:c},[l(N,{class:"sticky-hora",style:{padding:"0",margin:"0",border:"0"}},{default:m(()=>[f(h(o.hora),1)]),_:2},1024),(u(!0),g(b,null,M(t.salas,(ne,d)=>(u(),g("td",{key:d,class:S([{"bg-green text-white":t.seleccionadas[`${c}-${d}`]&&!s.$store.reservas[`${c}-${d}`],"bg-red text-white":s.$store.reservas[`${c}-${d}`]?.color==="red","bg-yellow text-black":s.$store.reservas[`${c}-${d}`]?.color==="yellow","bg-grey-3":!t.seleccionadas[`${c}-${d}`]&&!s.$store.reservas[`${c}-${d}`]},"text-center cursor-pointer"]),onClick:ce=>i.toggleSeleccion(c,d,o.hora)},[s.$store.reservas[`${c}-${d}`]?(u(),g("div",ee,[i.esPrimeraCeldaReserva(c,d)?(u(),g(b,{key:0},[f(h(s.$store.reservas[`${c}-${d}`].nombre)+" ",1),s.$store.reservas[`${c}-${d}`]&&s.$store.reservas[`${c}-${d}`].fecha_confirmacion?(u(),g("div",se,h(s.$store.reservas[`${c}-${d}`].fecha_confirmacion.substring(11,16)),1)):k("",!0)],64)):(u(),g(b,{key:1},[f(" ... ")],64))])):k("",!0)],10,I))),128))]))),128))])]),_:1})]),_:1})]),_:1}),l(H,{modelValue:t.dialogoReservar,"onUpdate:modelValue":e[11]||(e[11]=o=>t.dialogoReservar=o)},{default:m(()=>[l(C,{style:{"min-width":"250px"}},{default:m(()=>[l(V,{class:"q-pb-none row items-center"},{default:m(()=>[n("div",te,[f(h(i.fechaText)+" ",1),n("div",oe,h(Object.keys(t.seleccionadas).length>0?t.salas[Object.keys(t.seleccionadas)[0].split("-")[1]].sala:"-"),1)]),l(P),l(y,{flat:"",dense:"",round:"",icon:"close",class:"q-ml-auto",onClick:e[2]||(e[2]=o=>t.dialogoReservar=!1)})]),_:1}),l(V,null,{default:m(()=>[l(U,{onSubmit:q(i.confirmarReserva,["prevent"])},{default:m(()=>[l(p,{modelValue:t.nombre,"onUpdate:modelValue":e[3]||(e[3]=o=>t.nombre=o),label:"Nombre",dense:"",outlined:"",class:"",rules:[o=>!!o||"Por favor, ingresa un nombre."]},null,8,["modelValue","rules"]),l(p,{modelValue:t.personas,"onUpdate:modelValue":e[4]||(e[4]=o=>t.personas=o),modelModifiers:{number:!0},type:"number",label:"Número de Personas",dense:"",outlined:"",class:"",rules:[o=>o>0||"Por favor, ingresa un número válido."]},null,8,["modelValue","rules"]),l(p,{modelValue:t.adelanto,"onUpdate:modelValue":e[5]||(e[5]=o=>t.adelanto=o),modelModifiers:{number:!0},type:"number",label:"Adelanto",dense:"",outlined:"",class:"",rules:[o=>o>=0||"Por favor, ingresa un número válido."]},null,8,["modelValue","rules"]),l(p,{modelValue:t.observacion,"onUpdate:modelValue":e[6]||(e[6]=o=>t.observacion=o),label:"Observación",dense:"",outlined:"",type:"textarea"},null,8,["modelValue"]),s.$store.user.role==="Admin"?(u(),$(T,{key:0,modelValue:t.directo,"onUpdate:modelValue":[e[7]||(e[7]=o=>t.directo=o),e[8]||(e[8]=o=>t.adelanto=i.montoTotal)],label:t.directo?"Venta Directa":"Reserva",class:S({"text-primary":t.directo,"text-orange":!t.directo})},null,8,["modelValue","label","class"])):s.$store.user.sucursal===r.agencia?(u(),$(T,{key:1,modelValue:t.directo,"onUpdate:modelValue":[e[9]||(e[9]=o=>t.directo=o),e[10]||(e[10]=o=>t.adelanto=i.montoTotal)],label:t.directo?"Venta Directa":"Reserva",class:S({"text-primary":t.directo,"text-orange":!t.directo})},null,8,["modelValue","label","class"])):k("",!0),n("div",null,[l(Q,{color:"indigo",class:"q-pa-sm"},{default:m(()=>[f(" Horario Seleccionado: Desde "+h(i.horaMinima)+" hasta "+h(i.horaMaxima),1)]),_:1})]),n("div",re," Tiempo Total: "+h(i.tiempoSeleccionado),1),n("div",ae," Monto Total: "+h(i.montoTotal)+" Bs ",1),n("div",le," Saldo: "+h(i.montoTotal-t.adelanto)+" Bs ",1),l(B,{align:"right"},{default:m(()=>[D(l(y,{flat:"",label:"Cancelar","no-caps":"",loading:t.loading},null,8,["loading"]),[[A]]),l(y,{color:"green",label:"Confirmar","no-caps":"",type:"submit",loading:t.loading},null,8,["loading"])]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}const pe=x(E,[["render",ie]]);export{pe as F};
