import{v as Q,x as R,j as O,ad as j,a4 as g,o as u,a as l,w as m,e as V,b as n,a7 as y,t as h,ap as p,f as $,a0 as v,c as k,a3 as S,a5 as b,a6 as M,Q as C,aw as q,aq as w,ar as B,Z as D,h as H}from"./index-C05ozP0x.js";import{Q as T,a as N}from"./QTh-Cg7FQZlL.js";import{Q as x}from"./QMarkupTable-DK0wuBaQ.js";import{Q as F}from"./QSpace-CnhSba8s.js";import{Q as P}from"./QForm-Bi75cvdv.js";import{C as U}from"./ClosePopup-DD-gS7DT.js";import{h as f}from"./moment-C5S46NFB.js";import{_ as A}from"./_plugin-vue_export-helper-DlAUqK2U.js";const z=["top","middle","bottom"],_=Q({name:"QBadge",props:{color:String,textColor:String,floating:Boolean,transparent:Boolean,multiLine:Boolean,outline:Boolean,rounded:Boolean,label:[Number,String],align:{type:String,validator:e=>z.includes(e)}},setup(e,{slots:s}){const o=R(()=>e.align!==void 0?{verticalAlign:e.align}:null),r=R(()=>{const t=e.outline===!0&&e.color||e.textColor;return`q-badge flex inline items-center no-wrap q-badge--${e.multiLine===!0?"multi":"single"}-line`+(e.outline===!0?" q-badge--outline":e.color!==void 0?` bg-${e.color}`:"")+(t!==void 0?` text-${t}`:"")+(e.floating===!0?" q-badge--floating":"")+(e.rounded===!0?" q-badge--rounded":"")+(e.transparent===!0?" q-badge--transparent":"")});return()=>O("div",{class:r.value,style:o.value,role:"status","aria-label":e.label},j(s.default,e.label!==void 0?[e.label]:[]))}}),E={name:"FormularioReservas",props:{agencia:{type:String,required:!1},color:{type:String,required:!1}},data(){return{fecha:f().format("YYYY-MM-DD"),salas:[],horarios:[],seleccionadas:{},totalMinutos:0,dialogoReservar:!1,nombre:"",personas:1,adelanto:0,observacion:"",loading:!1,directo:!1}},computed:{fechaText(){const e=["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"],s=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];return`${e[f(this.fecha).day()]} ${f(this.fecha).date()} de ${s[f(this.fecha).month()]} de ${f(this.fecha).year()}`},tiempoSeleccionado(){const e=Math.floor(this.totalMinutos/60),s=this.totalMinutos%60;return`${String(e).padStart(2,"0")}:${String(s).padStart(2,"0")}`},montoTotal(){return this.totalMinutos/30*5*(this.personas||1)},horaMinima(){return Object.keys(this.seleccionadas).length===0?"-":Object.values(this.seleccionadas).map(s=>f(s,"H:mm")).sort((s,o)=>s.diff(o))[0].format("H:mm")},horaMaxima(){if(Object.keys(this.seleccionadas).length===0)return"-";const e=Object.values(this.seleccionadas).map(o=>f(o,"H:mm")).sort((o,r)=>o.diff(r));return e[e.length-1].add(30,"minutes").format("H:mm")}},methods:{esPrimeraCeldaReserva(e,s){const o=`${e}-${s}`,r=`${e-1}-${s}`;return this.$store.reservas[o]?!this.$store.reservas[r]||this.$store.reservas[r].nombre!==this.$store.reservas[o].nombre:!1},getRowspan(e,s){const o=`${e}-${s}`;if(!this.$store.reservas[o])return 1;let r=1;for(;this.$store.reservas[`${e+r}-${s}`]&&this.$store.reservas[`${e+r}-${s}`].nombre===this.$store.reservas[o].nombre;)r++;return r},getReservas(e,s){this.loading=!0,this.$store.reservas={},this.$axios.get("/reservas",{params:{fecha:e,agencia:s}}).then(o=>{this.$store.reservas=o.data}).catch(()=>{this.$alert.error("Error al obtener reservas")}).finally(()=>{this.loading=!1})},limpiar(){this.seleccionadas={},this.totalMinutos=0,this.nombre="",this.personas=1,this.adelanto=0,this.observacion=""},clickReserva(){if(this.totalMinutos===0){this.$alert.error("Por favor selecciona al menos 30 minutos.");return}this.dialogoReservar=!0,this.nombre="",this.personas=2,this.adelanto=0,this.observacion="",this.directo=!1},shouldShowCell(e,s){const o=`${e}-${s}`,r=`${e-1}-${s}`;return this.$store.reservas[o]?!(e>0&&this.$store.reservas[r]&&this.$store.reservas[r].nombre===this.$store.reservas[o].nombre):!0},toggleSeleccion(e,s,o){const r=`${e}-${s}`;if(!this.$store.reservas[r]){if(Object.keys(this.seleccionadas).length===0){this.seleccionadas[r]=o,this.calcularTotalMinutos();return}if(Object.keys(this.seleccionadas).length>0){const t=new Set(Object.keys(this.seleccionadas).map(a=>a.split("-")[1]));if(t.size>0&&!t.has(String(s))){this.$alert.error("Debes seleccionar en la misma sala.");return}const i=Object.keys(this.seleccionadas).map(a=>parseInt(a.split("-")[0])).sort((a,c)=>a-c);if(i.length>0){const a=i[i.length-1];if(e!==a+1){this.$alert.error("Debes seleccionar horarios consecutivos.");return}}}this.seleccionadas[r]?delete this.seleccionadas[r]:this.seleccionadas[r]=o,this.calcularTotalMinutos()}},calcularTotalMinutos(){this.totalMinutos=Object.keys(this.seleccionadas).length*30},confirmarReserva(){Object.keys(this.seleccionadas).forEach(r=>{this.$store.reservas[r]={nombre:this.nombre,personas:this.personas,color:"yellow"}});const s=Object.keys(this.seleccionadas)[0].split("-")[1],o=this.salas[s]?.sala||"Desconocida";this.loading=!0,this.$axios.post("/reservas",{nombre:this.nombre,numero_personas:this.personas,observaciones:this.observacion,json:JSON.stringify(this.seleccionadas),sala:o,total:this.montoTotal,adelanto:this.adelanto,tiempo:this.tiempoSeleccionado,horario:`${this.horaMinima} - ${this.horaMaxima}`,fecha:this.fecha,directo:this.directo,agencia:this.agencia}).then(()=>{this.$alert.success("Reserva confirmada","Reserva"),this.limpiar(),this.getReservas(this.fecha,this.agencia),this.dialogoReservar=!1,this.$socket.emit(`reservas-${this.agencia}`)}).catch(r=>{this.$alert.error(r.response.data.message,"Error al confirmar reserva")}).finally(()=>{this.loading=!1})}},mounted(){console.log("agencia "+this.agencia),console.log("color "+this.color);let e=20;this.agencia==="Ayacucho"&&(e=21);for(let o=0;o<e;o++)this.salas.push({sala:"Sala "+(o+1)});for(let o=8;o<23;o++){let r=`${o}:00`,t=`${o}:30`;this.horarios.push({hora:`${r}-${t}`}),r=`${o}:30`,t=`${o+1}:00`,this.horarios.push({hora:`${r}-${t}`})}this.calcularTotalMinutos(),this.getReservas(this.fecha,this.agencia);let s=this;this.$store.socketReservas||(this.$store.socketReservas={}),this.$store.socketReservas[this.agencia]||(this.$socket.on(`reservas-${this.agencia}`,()=>{s.getReservas(this.fecha,this.agencia)}),this.$store.socketReservas[this.agencia]=!0)}},L={class:"row"},J={class:"col-12"},K={class:"col-6 col-md-2"},Y={class:"col-6 col-md-2 text-center flex flex-center"},Z={class:"text-bold text-red"},G={class:"col-6 col-md-2 flex flex-center"},W={class:"col-6 col-md-2"},X={class:"col-6 col-md-2 text-right"},I={class:"scroll-body"},ee=["onClick"],se={key:0},te={key:0},oe={class:"text-subtitle2 text-bold"},ae={class:"text-red"},re={class:"text-bold q-mt-md text-blue bg-grey-3"},le={class:"text-bold"},ie={class:"text-red text-bold"};function ne(e,s,o,r,t,i){return u(),g(b,null,[l(C,{flat:"",bordered:""},{default:m(()=>[l(V,{class:"q-pa-xs"},{default:m(()=>[n("div",L,[n("div",J,[n("div",{class:y(`bg-${o.color} text-center text-white q-pa-xs`)},h(o.agencia),3)]),n("div",K,[l(p,{modelValue:t.fecha,"onUpdate:modelValue":[s[0]||(s[0]=a=>t.fecha=a),s[1]||(s[1]=a=>i.getReservas(t.fecha,o.agencia))],type:"date",label:"Fecha",dense:"",outlined:""},null,8,["modelValue"])]),n("div",Y,[n("div",Z,h(i.fechaText),1)]),n("div",G,[l($,{color:"green",label:"Reservar",onClick:i.clickReserva,"no-caps":"",icon:"save",size:"11px",loading:t.loading},null,8,["onClick","loading"])]),n("div",W,[l(_,{color:"indigo",class:"q-pa-sm"},{default:m(()=>[v(" Tiempo Seleccionado: "+h(i.tiempoSeleccionado),1)]),_:1})]),n("div",X,[Object.keys(t.seleccionadas).length>0?(u(),k($,{key:0,color:"red",label:"Limpiar",onClick:i.limpiar,"no-caps":"",icon:"clear",size:"11px"},null,8,["onClick"])):S("",!0)]),s[12]||(s[12]=n("div",{class:"col-6 col-md-2 text-right"},null,-1))]),l(x,{"wrap-cells":"",dense:"",bordered:"",flat:"",separator:"cell",class:"tabla-reservas"},{default:m(()=>[n("thead",null,[n("tr",null,[l(T,{class:"bg-grey text-white sticky-hora"},{default:m(()=>s[13]||(s[13]=[v("Hora")])),_:1}),(u(!0),g(b,null,M(t.salas,a=>(u(),k(T,{class:y(`bg-${o.color} text-white`),key:a.sala},{default:m(()=>[v(h(a.sala),1)]),_:2},1032,["class"]))),128))])]),n("tbody",I,[(u(!0),g(b,null,M(t.horarios,(a,c)=>(u(),g("tr",{key:c},[l(N,{class:"sticky-hora",style:{padding:"0",margin:"0",border:"0"}},{default:m(()=>[v(h(a.hora),1)]),_:2},1024),(u(!0),g(b,null,M(t.salas,(ce,d)=>(u(),g("td",{key:d,class:y([{"bg-green text-white":t.seleccionadas[`${c}-${d}`]&&!e.$store.reservas[`${c}-${d}`],"bg-red text-white":e.$store.reservas[`${c}-${d}`]?.color==="red","bg-yellow text-black":e.$store.reservas[`${c}-${d}`]?.color==="yellow","bg-grey-3":!t.seleccionadas[`${c}-${d}`]&&!e.$store.reservas[`${c}-${d}`]},"text-center cursor-pointer"]),onClick:de=>i.toggleSeleccion(c,d,a.hora)},[e.$store.reservas[`${c}-${d}`]?(u(),g("div",se,[i.esPrimeraCeldaReserva(c,d)?(u(),g(b,{key:0},[v(h(e.$store.reservas[`${c}-${d}`].nombre)+" ",1),e.$store.reservas[`${c}-${d}`]&&e.$store.reservas[`${c}-${d}`].fecha_confirmacion?(u(),g("div",te,h(e.$store.reservas[`${c}-${d}`].fecha_confirmacion.substring(11,16)),1)):S("",!0)],64)):(u(),g(b,{key:1},[v(" ... ")],64))])):S("",!0)],10,ee))),128))]))),128))])]),_:1})]),_:1})]),_:1}),l(H,{modelValue:t.dialogoReservar,"onUpdate:modelValue":s[11]||(s[11]=a=>t.dialogoReservar=a)},{default:m(()=>[l(C,{style:{"min-width":"250px"}},{default:m(()=>[l(V,{class:"q-pb-none row items-center"},{default:m(()=>[n("div",oe,[v(h(i.fechaText)+" ",1),n("div",ae,h(Object.keys(t.seleccionadas).length>0?t.salas[Object.keys(t.seleccionadas)[0].split("-")[1]].sala:"-"),1)]),l(F),l($,{flat:"",dense:"",round:"",icon:"close",class:"q-ml-auto",onClick:s[2]||(s[2]=a=>t.dialogoReservar=!1)})]),_:1}),l(V,null,{default:m(()=>[l(P,{onSubmit:q(i.confirmarReserva,["prevent"])},{default:m(()=>[l(p,{modelValue:t.nombre,"onUpdate:modelValue":s[3]||(s[3]=a=>t.nombre=a),label:"Nombre",dense:"",outlined:"",class:"",rules:[a=>!!a||"Por favor, ingresa un nombre."]},null,8,["modelValue","rules"]),l(p,{modelValue:t.personas,"onUpdate:modelValue":s[4]||(s[4]=a=>t.personas=a),modelModifiers:{number:!0},type:"number",label:"Número de Personas",dense:"",outlined:"",class:"",rules:[a=>a>0||"Por favor, ingresa un número válido."]},null,8,["modelValue","rules"]),l(p,{modelValue:t.adelanto,"onUpdate:modelValue":s[5]||(s[5]=a=>t.adelanto=a),modelModifiers:{number:!0},type:"number",label:"Adelanto",dense:"",outlined:"",class:"",rules:[a=>a>=0||"Por favor, ingresa un número válido."]},null,8,["modelValue","rules"]),l(p,{modelValue:t.observacion,"onUpdate:modelValue":s[6]||(s[6]=a=>t.observacion=a),label:"Observación",dense:"",outlined:"",type:"textarea"},null,8,["modelValue"]),e.$store.user.role==="Admin"?(u(),k(w,{key:0,modelValue:t.directo,"onUpdate:modelValue":[s[7]||(s[7]=a=>t.directo=a),s[8]||(s[8]=a=>t.adelanto=i.montoTotal)],label:t.directo?"Venta Directa":"Reserva",class:y({"text-primary":t.directo,"text-orange":!t.directo})},null,8,["modelValue","label","class"])):e.$store.user.sucursal===o.agencia?(u(),k(w,{key:1,modelValue:t.directo,"onUpdate:modelValue":[s[9]||(s[9]=a=>t.directo=a),s[10]||(s[10]=a=>t.adelanto=i.montoTotal)],label:t.directo?"Venta Directa":"Reserva",class:y({"text-primary":t.directo,"text-orange":!t.directo})},null,8,["modelValue","label","class"])):S("",!0),n("div",null,[l(_,{color:"indigo",class:"q-pa-sm"},{default:m(()=>[v(" Horario Seleccionado: Desde "+h(i.horaMinima)+" hasta "+h(i.horaMaxima),1)]),_:1})]),n("div",re," Tiempo Total: "+h(i.tiempoSeleccionado),1),n("div",le," Monto Total: "+h(i.montoTotal)+" Bs ",1),n("div",ie," Saldo: "+h(i.montoTotal-t.adelanto)+" Bs ",1),l(B,{align:"right"},{default:m(()=>[D(l($,{flat:"",label:"Cancelar","no-caps":"",loading:t.loading},null,8,["loading"]),[[U]]),l($,{color:"green",label:"Confirmar","no-caps":"",type:"submit",loading:t.loading},null,8,["loading"])]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}const pe=A(E,[["render",ne]]);export{pe as F};
